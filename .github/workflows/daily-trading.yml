name: Daily Stock Prediction & Trading Automation

on:
  schedule:
    # Run daily at 4:00 PM IST (10:30 AM UTC) - After NSE market close (3:30 PM IST)
    # Indian Stock Exchange (NSE) trading hours: 9:15 AM - 3:30 PM IST (Monday-Friday)
    - cron: '30 10 * * 1-5'  # Monday to Friday only (market trading days)
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even on non-trading days'
        required: false
        default: 'false'
        type: boolean

jobs:
  daily-stock-predictions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install openpyxl xlsxwriter
        sudo apt-get update && sudo apt-get install -y jq

    - name: Create required directories for results
      run: |
        mkdir -p daily_predictions/{json,csv,summary}
        mkdir -p predictions
        mkdir -p evaluations  
        mkdir -p results
        mkdir -p logs
        echo "ğŸ“ Created result directories"

    - name: Set up Git configuration for automated commits
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        echo "ğŸ“ Git configured for automated commits"

    - name: Run Daily Stock Predictions & Analysis
      run: |
        echo "ğŸš€ Starting daily stock prediction automation at $(date)"
        echo "ğŸ“… Target: Generate predictions for next trading day"
        echo "ğŸ“Š Coverage: 40 Indian stocks across 8 sectors"
        echo "ğŸ¤– Models: Baseline LSTM, MSLSTM, MSLSTMA, Stacked Ensemble (All 4 models)"
        echo "ğŸ’° P/L Tracking: Individual model performance evaluation"
        
        if python daily_predictions.py; then
          echo "âœ… Daily automation completed successfully at $(date)"
          
          echo ""
          echo "ğŸ“ Generated Files:"
          find . -name "*.csv" -o -name "*.json" -o -name "*.md" | grep -E "(daily_predictions|predictions|evaluations|results)" | sort
          
          echo ""
          echo "ğŸ“Š Summary of results:"
          if [ -f "daily_predictions/summary/summary_$(date +%Y-%m-%d).md" ]; then
            echo "âœ… Daily summary report with model P/L analysis generated"
          fi
          if [ -f "daily_predictions/csv/predictions_$(date +%Y-%m-%d).csv" ]; then
            echo "âœ… Multi-model prediction CSV generated"
            TOTAL_PREDICTIONS=$(wc -l < daily_predictions/csv/predictions_$(date +%Y-%m-%d).csv)
            STOCKS_COUNT=$((TOTAL_PREDICTIONS / 4))
            echo "ğŸ“ˆ Predictions: $STOCKS_COUNT stocks Ã— 4 models = $TOTAL_PREDICTIONS total predictions"
          fi
          if [ -f "daily_predictions/csv/ensemble_summary_$(date +%Y-%m-%d).csv" ]; then
            echo "âœ… Ensemble summary CSV generated for quick reference"
          fi
          
        else
          echo "âŒ Daily automation failed at $(date)"
          echo "ğŸ“‹ Checking for any partial results..."
          find . -name "*.log" -o -name "*.csv" -o -name "*.json" | head -10
          exit 1
        fi

    - name: Create Daily Summary Log
      run: |
        echo "Creating daily summary log..."
        mkdir -p logs
        CURRENT_DATE=$(date +%Y%m%d)
        cat > logs/daily_summary_${CURRENT_DATE}.log << 'EOF'
        Daily Trading Simulation Summary
        ================================
        Date: $(date)
        Trigger: ${{ github.event_name }}
        
        Multi-Model Prediction System:
        - Baseline LSTM: Individual predictions and P/L tracking
        - MSLSTM: Enhanced model with memory states  
        - MSLSTMA: Attention-enhanced MSLSTM variant
        - Stacked Ensemble: Combined model predictions
        
        Status: Completed Successfully
        EOF

    - name: Store All Results in GitHub Repository  
      run: |
        echo "ğŸ’¾ Storing all prediction results in GitHub..."
        
        for dir in daily_predictions predictions evaluations results logs; do
          if [ -d "$dir" ] && [ "$(ls -A $dir 2>/dev/null)" ]; then
            echo "ğŸ“ Adding $dir/ ($(find $dir -type f | wc -l) files)"
            git add "$dir/"
          else
            echo "âš ï¸ Directory $dir/ is empty or doesn't exist"
          fi
        done
        
        git add *.csv *.json *.log *.xlsx *.md 2>/dev/null || true
        
        COMMIT_DATE=$(date +%Y-%m-%d)
        COMMIT_TIME=$(date +%H:%M:%S)
        
        CHANGED_FILES=$(git status --porcelain | wc -l)
        
        if [ "$CHANGED_FILES" -gt 0 ]; then
          echo "ğŸ“Š Committing $CHANGED_FILES changed files..."
          
          git commit -m "ğŸ¤– Multi-Model Stock Predictions - $COMMIT_DATE

ğŸ“… Date: $COMMIT_DATE at $COMMIT_TIME UTC
ğŸ¯ Models: Baseline LSTM, MSLSTM, MSLSTMA, Stacked Ensemble
ğŸ’° Features: Individual model P/L tracking & ROI analysis
ğŸ“ˆ Target: Next trading day forecasts
ğŸ”„ Automation: GitHub Actions

Files updated: Multi-model predictions, evaluations, and summaries"

          if git push origin main; then
            echo "âœ… All results successfully stored in GitHub!"
            echo "ğŸ”— View results at: https://github.com/${{ github.repository }}"
          else
            echo "âŒ Failed to push results to GitHub"
            exit 1
          fi
        else
          echo "â„¹ï¸ No new results to commit"
        fi

    - name: Create Weekly Release
      if: github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && contains(github.event.schedule, '5'))
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: weekly-predictions-${{ github.run_number }}
        name: ğŸ“Š Multi-Model Stock Predictions - Week ${{ github.run_number }}
        body: |
          ## ğŸ“ˆ Weekly Multi-Model Stock Market Predictions Summary
          
          **Coverage**: 40 Indian stocks across 8 sectors  
          **Models**: Baseline LSTM, MSLSTM, MSLSTMA, Stacked Ensemble  
          **Features**: Individual model P/L tracking, ROI analysis, direction accuracy
          
          ### ğŸ¤– Enhanced Multi-Model System:
          - **Baseline LSTM**: Traditional LSTM model with basic features
          - **MSLSTM**: Multi-Scale LSTM with enhanced memory states
          - **MSLSTMA**: MSLSTM with Attention mechanism for better focus
          - **Stacked Ensemble**: Combined predictions from all models
          
          ### ğŸ“ Repository Contents:
          - `daily_predictions/csv/`: Multi-model prediction data (all 4 models per stock)
          - `daily_predictions/summary/`: Human-readable reports with P/L analysis
          - `evaluations/`: Model performance tracking with profit/loss metrics
          - `predictions/`: Raw model predictions in JSON format  
          - `logs/`: Execution logs and system information
          
          ### ğŸ¯ Key Features:
          - âœ… Individual predictions from all 4 models per stock
          - âœ… Profit/Loss tracking for each model separately
          - âœ… ROI percentage calculation per model
          - âœ… Direction accuracy comparison across models
          - âœ… Best/worst performing model identification
          - âœ… Automated daily performance evaluation
          
          ### ğŸ“Š Usage:
          - **Quick Overview**: Check `daily_predictions/csv/ensemble_summary_YYYY-MM-DD.csv`
          - **Detailed Analysis**: See `daily_predictions/summary/summary_YYYY-MM-DD.md`
          - **Model Comparison**: View `daily_predictions/csv/predictions_YYYY-MM-DD.csv`
          - **P/L Performance**: Check `evaluations/evaluation_YYYY-MM-DD.json`
          
          ### ğŸ’° Performance Metrics:
          Each model is evaluated on:
          - **Profit/Loss**: Actual trading simulation results (â‚¹10,000 per trade)
          - **ROI**: Return on Investment percentage
          - **Direction Accuracy**: Percentage of correct up/down predictions
          - **Price Error**: Average prediction error percentage
          
          *Generated automatically by GitHub Actions - Multi-model predictions updated daily*
        draft: false
        prerelease: false

    - name: Upload artifacts (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: simulation-logs
        path: |
          logs/
          *.log
          *.txt
          daily_predictions/
        retention-days: 7
        if-no-files-found: ignore
