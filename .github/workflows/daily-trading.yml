name: Daily Stock Prediction & Trading Automation

permissions:
  contents: write
  actions: read

on:
  schedule:
    # Run daily at 4:00 PM IST (10:30 AM UTC) - After NSE market close (3:30 PM IST)
    # Indian Stock Exchange (NSE) trading hours: 9:15 AM - 3:30 PM IST (Monday-Friday)
    - cron: '30 10 * * 1-5'  # Monday to Friday only (market trading days)
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even on non-trading days'
        required: false
        default: 'false'
        type: boolean

jobs:
  daily-stock-predictions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install openpyxl xlsxwriter
        sudo apt-get update && sudo apt-get install -y jq

    - name: Create required directories for results
      run: |
        mkdir -p daily_predictions/{json,csv,summary}
        mkdir -p predictions
        mkdir -p evaluations  
        mkdir -p results
        mkdir -p logs
        echo "üìÅ Created result directories"

    - name: Set up Git configuration for automated commits
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        echo "üìù Git configured for automated commits"

    - name: Run Daily Stock Predictions & Analysis
      run: |
        echo "üöÄ Starting daily stock prediction automation at $(date)"
        echo "üìÖ Target: Generate predictions for next trading day"
        echo "üìä Coverage: 40 Indian stocks across 8 sectors"
        echo "ü§ñ Models: Baseline LSTM, MSLSTM, MSLSTMA, Stacked Ensemble (All 4 models)"
        echo "üí∞ P/L Tracking: Individual model performance evaluation"
        
        if python daily_predictions.py; then
          echo " Daily automation completed successfully at $(date)"
          
          echo ""
          echo "üìÅ Generated Files:"
          find . -name "*.csv" -o -name "*.json" -o -name "*.md" | grep -E "(daily_predictions|predictions|evaluations|results)" | sort
          
          echo ""
          echo "üìä Summary of results:"
          if [ -f "daily_predictions/summary/summary_$(date +%Y-%m-%d).md" ]; then
            echo " Daily summary report with model P/L analysis generated"
          fi
          if [ -f "daily_predictions/csv/predictions_$(date +%Y-%m-%d).csv" ]; then
            echo " Multi-model prediction CSV generated"
            TOTAL_PREDICTIONS=$(wc -l < daily_predictions/csv/predictions_$(date +%Y-%m-%d).csv)
            STOCKS_COUNT=$((TOTAL_PREDICTIONS / 4))
            echo " Predictions: $STOCKS_COUNT stocks √ó 4 models = $TOTAL_PREDICTIONS total predictions"
          fi
          if [ -f "daily_predictions/csv/ensemble_summary_$(date +%Y-%m-%d).csv" ]; then
            echo " Ensemble summary CSV generated for quick reference"
          fi
          
        else
          echo " Daily automation failed at $(date)"
          echo "üìã Checking for any partial results..."
          find . -name "*.log" -o -name "*.csv" -o -name "*.json" | head -10
          exit 1
        fi

    - name: Create Daily Summary Log
      run: |
        echo "Creating daily summary log..."
        mkdir -p logs
        CURRENT_DATE=$(date +%Y%m%d)
        cat > logs/daily_summary_${CURRENT_DATE}.log << 'EOF'
        Daily Trading Simulation Summary
        ================================
        Date: $(date)
        Trigger: ${{ github.event_name }}
        
        Multi-Model Prediction System:
        - Baseline LSTM: Individual predictions and P/L tracking
        - MSLSTM: Enhanced model with memory states  
        - MSLSTMA: Attention-enhanced MSLSTM variant
        - Stacked Ensemble: Combined model predictions
        
        Status: Completed Successfully
        EOF

    - name: Store All Results in GitHub Repository  
      run: |
        echo "üíæ Storing all prediction results in GitHub..."
        
        for dir in daily_predictions predictions evaluations results logs; do
          if [ -d "$dir" ] && [ "$(ls -A $dir 2>/dev/null)" ]; then
            echo "üìÅ Adding $dir/ ($(find $dir -type f | wc -l) files)"
            git add "$dir/"
          else
            echo "‚ö†Ô∏è Directory $dir/ is empty or doesn't exist"
          fi
        done
        
        git add *.csv *.json *.log *.xlsx *.md 2>/dev/null || true
        
        COMMIT_DATE=$(date +%Y-%m-%d)
        COMMIT_TIME=$(date +%H:%M:%S)
        
        if [ "$(git status --porcelain | wc -l)" -gt 0 ]; then
          echo "üìä Committing prediction results..."
          git commit -m "Daily predictions $COMMIT_DATE"
          git push origin main
          echo " Results saved to GitHub"
        else
          echo "‚ÑπÔ∏è No new results to commit"
        fi

    - name: Create Weekly Release
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: weekly-predictions-${{ github.run_number }}
        name: Stock Predictions - Week ${{ github.run_number }}
        body: |
          Multi-model stock predictions for 39 Indian stocks.
          
          Models: Baseline LSTM, MSLSTM, MSLSTMA, Stacked Ensemble
          Features: Individual P/L tracking and ROI analysis
          
          Check daily_predictions/ folder for results.
        draft: false

    - name: Upload artifacts (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: simulation-logs
        path: |
          logs/
          *.log
          *.txt
          daily_predictions/
        retention-days: 7
        if-no-files-found: ignore
