name: Daily Stock Prediction & Trading Automation

on:
  schedule:
    # Run daily at 4:00 PM IST (10:30 AM UTC) - After NSE market close (3:30 PM IST)
    # Indian Stock Exchange (NSE) trading hours: 9:15 AM - 3:30 PM IST (Monday-Friday)
    - cron: '30 10 * * 1-5'  # Monday to Friday only (market trading days)
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even on non-trading days'
        required: false
        default: 'false'
        type: boolean

jobs:
  daily-stock-predictions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install openpyxl xlsxwriter
        # Install jq for JSON parsing in evaluation summaries
        sudo apt-get update && sudo apt-get install -y jq

    - name: Create required directories for results
      run: |
        mkdir -p daily_predictions/{json,csv,summary}
        mkdir -p predictions
        mkdir -p evaluations  
        mkdir -p results
        mkdir -p logs
        echo "üìÅ Created result directories"

    - name: Set up Git configuration for automated commits
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        echo "üìù Git configured for automated commits"

    - name: Run Daily Stock Predictions & Analysis
      run: |
        echo "üöÄ Starting daily stock prediction automation at $(date)"
        echo "üìÖ Target: Generate predictions for next trading day"
        echo "üìä Coverage: 40 Indian stocks across 8 sectors"
        echo "ü§ñ Models: Baseline LSTM, MSLSTM, MSLSTMA, Stacked Ensemble (All 4 models)"
        echo "üí∞ P/L Tracking: Individual model performance evaluation"
        
        # Run the comprehensive daily automation
        if python daily_predictions.py; then
          echo "‚úÖ Daily automation completed successfully at $(date)"
          
          # Show what was generated
          echo ""
          echo "üìÅ Generated Files:"
          find . -name "*.csv" -o -name "*.json" -o -name "*.md" | grep -E "(daily_predictions|predictions|evaluations|results)" | sort
          
          echo ""
          echo "üìä Summary of results:"
          if [ -f "daily_predictions/summary/summary_$(date +%Y-%m-%d).md" ]; then
            echo "‚úÖ Daily summary report with model P/L analysis generated"
          fi
          if [ -f "daily_predictions/csv/predictions_$(date +%Y-%m-%d).csv" ]; then
            echo "‚úÖ Multi-model prediction CSV generated"
            TOTAL_PREDICTIONS=$(wc -l < daily_predictions/csv/predictions_$(date +%Y-%m-%d).csv)
            STOCKS_COUNT=$((TOTAL_PREDICTIONS / 4))  # 4 models per stock
            echo "üìà Predictions: $STOCKS_COUNT stocks √ó 4 models = $TOTAL_PREDICTIONS total predictions"
          fi
          if [ -f "daily_predictions/csv/ensemble_summary_$(date +%Y-%m-%d).csv" ]; then
            echo "‚úÖ Ensemble summary CSV generated for quick reference"
          fi
          if [ -f "evaluations/evaluation_$(date --date='yesterday' +%Y-%m-%d).json" ] 2>/dev/null; then
            echo "‚úÖ Previous day model performance evaluation completed"
            # Extract model performance if evaluation exists
            if command -v jq >/dev/null 2>&1; then
              echo "üèÜ Model Performance Summary:"
              jq -r '.summary.model_performance | to_entries[] | "  " + .key + ": ROI " + (.value.roi_pct | tostring) + "%, Accuracy " + (.value.direction_accuracy | tostring) + "%"' "evaluations/evaluation_$(date --date='yesterday' +%Y-%m-%d).json" 2>/dev/null || true
            fi
          fi
          
        else
          echo "‚ùå Daily automation failed at $(date)"
          echo "üìã Checking for any partial results..."
          find . -name "*.log" -o -name "*.csv" -o -name "*.json" | head -10
          exit 1
        fi

    - name: Create Daily Summary Log
      run: |
        echo "Creating daily summary log..."
        mkdir -p logs
        cat > logs/daily_summary_$(date +%Y%m%d).log << EOF
        Daily Trading Simulation Summary
        ================================
        Date: $(date)
        Trigger: ${{ github.event_name }}
        
        Multi-Model Prediction System:
        - Baseline LSTM: Individual predictions and P/L tracking
        - MSLSTM: Enhanced model with memory states  
        - MSLSTMA: Attention-enhanced MSLSTM variant
        - Stacked Ensemble: Combined model predictions
        
        Files Generated:
        $(find . -name "*.csv" -o -name "*.json" -o -name "*.xlsx" | head -10 | sed 's/^/- /')
        
        Prediction Results:
        $(find daily_predictions predictions evaluations results -name "*.csv" 2>/dev/null | head -8 | sed 's/^/- /' || echo "- No prediction files found")
        
        Model Performance Files:
        $(find evaluations -name "evaluation_*.json" 2>/dev/null | tail -3 | sed 's/^/- /' || echo "- No evaluation files found yet")
        
        Status: Completed Successfully
        EOF

    - name: Store All Results in GitHub Repository  
      run: |
        echo "üíæ Storing all prediction results in GitHub..."
        
        # Add all result files and directories (with existence check)
        for dir in daily_predictions predictions evaluations results logs; do
          if [ -d "$dir" ] && [ "$(ls -A $dir 2>/dev/null)" ]; then
            echo "üìÅ Adding $dir/ ($(find $dir -type f | wc -l) files)"
            git add "$dir/"
          else
            echo "‚ö†Ô∏è Directory $dir/ is empty or doesn't exist"
          fi
        done
        
        # Also add any individual result files in root
        git add *.csv *.json *.log *.xlsx *.md 2>/dev/null || true
        
        # Create comprehensive commit message
        COMMIT_DATE=$(date +%Y-%m-%d)
        COMMIT_TIME=$(date +%H:%M:%S)
        
        # Check what we're committing
        CHANGED_FILES=$(git status --porcelain | wc -l)
        
        if [ "$CHANGED_FILES" -gt 0 ]; then
          echo "üìä Committing $CHANGED_FILES changed files..."
          
          # Count predictions if available
          PREDICTION_COUNT="unknown"
          MODEL_COUNT="unknown"
          if [ -f "daily_predictions/csv/predictions_${COMMIT_DATE}.csv" ]; then
            TOTAL_PREDICTIONS=$(wc -l < "daily_predictions/csv/predictions_${COMMIT_DATE}.csv")
            PREDICTION_COUNT=$((TOTAL_PREDICTIONS - 1))  # Subtract header
            MODEL_COUNT=$((PREDICTION_COUNT / 40))  # Assuming 40 stocks
          fi
          
          # Check for evaluation data
          EVAL_INFO=""
          YESTERDAY=$(date --date='yesterday' +%Y-%m-%d)
          if [ -f "evaluations/evaluation_${YESTERDAY}.json" ]; then
            EVAL_INFO="üìä Previous day P/L evaluation included"
          fi
          
          git commit -m "ü§ñ Multi-Model Stock Predictions - $COMMIT_DATE

üìÖ Date: $COMMIT_DATE at $COMMIT_TIME UTC
üìä Predictions: $PREDICTION_COUNT total (40 stocks √ó $MODEL_COUNT models)
üéØ Models: Baseline LSTM, MSLSTM, MSLSTMA, Stacked Ensemble
üí∞ Features: Individual model P/L tracking & ROI analysis
üìà Target: Next trading day forecasts
üîÑ Automation: GitHub Actions (Scheduled)
$EVAL_INFO

Generated files:
$(git diff --name-only HEAD~1 HEAD 2>/dev/null | head -10 | sed 's/^/- /' || git ls-files --others --cached | head -10 | sed 's/^/- /')"

          # Push to GitHub
          if git push origin main; then
            echo "‚úÖ All results successfully stored in GitHub!"
            echo "üîó View results at: https://github.com/${{ github.repository }}"
          else
            echo "‚ùå Failed to push results to GitHub"
            exit 1
          fi
        else
          echo "‚ÑπÔ∏è No new results to commit"
        fi

    - name: Create Weekly Release (Fridays)
      if: github.event_name == 'schedule' && contains(github.event.schedule, '* * 5')
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: weekly-predictions-${{ github.run_number }}
        name: üìä Multi-Model Stock Predictions - Week ${{ github.run_number }}
        body: |
          ## üìà Weekly Multi-Model Stock Market Predictions Summary
          
          **Period**: Week ending $(date +%Y-%m-%d)  
          **Coverage**: 40 Indian stocks across 8 sectors  
          **Models**: Baseline LSTM, MSLSTM, MSLSTMA, Stacked Ensemble  
          **Features**: Individual model P/L tracking, ROI analysis, direction accuracy
          
          ### ü§ñ Enhanced Multi-Model System:
          - **Baseline LSTM**: Traditional LSTM model with basic features
          - **MSLSTM**: Multi-Scale LSTM with enhanced memory states
          - **MSLSTMA**: MSLSTM with Attention mechanism for better focus
          - **Stacked Ensemble**: Combined predictions from all models
          
          ### üìÅ Repository Contents:
          - `daily_predictions/csv/`: Multi-model prediction data (all 4 models per stock)
          - `daily_predictions/summary/`: Human-readable reports with P/L analysis
          - `evaluations/`: Model performance tracking with profit/loss metrics
          - `predictions/`: Raw model predictions in JSON format  
          - `results/`: Legacy prediction results
          - `logs/`: Execution logs and system information
          
          ### üéØ Key Features:
          - ‚úÖ Individual predictions from all 4 models per stock
          - ‚úÖ Profit/Loss tracking for each model separately
          - ‚úÖ ROI percentage calculation per model
          - ‚úÖ Direction accuracy comparison across models
          - ‚úÖ Best/worst performing model identification
          - ‚úÖ Automated daily performance evaluation
          
          ### üìä Usage:
          - **Quick Overview**: Check `daily_predictions/csv/ensemble_summary_YYYY-MM-DD.csv`
          - **Detailed Analysis**: See `daily_predictions/summary/summary_YYYY-MM-DD.md`
          - **Model Comparison**: View `daily_predictions/csv/predictions_YYYY-MM-DD.csv`
          - **P/L Performance**: Check `evaluations/evaluation_YYYY-MM-DD.json`
          
          ### üí∞ Performance Metrics:
          Each model is evaluated on:
          - **Profit/Loss**: Actual trading simulation results (‚Çπ10,000 per trade)
          - **ROI**: Return on Investment percentage
          - **Direction Accuracy**: Percentage of correct up/down predictions
          - **Price Error**: Average prediction error percentage
          
          *Generated automatically by GitHub Actions - Multi-model predictions updated daily*
        draft: false
        prerelease: false

    - name: Upload artifacts (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: simulation-logs
        path: |
          logs/
          *.log
          *.txt
          daily_predictions/
        retention-days: 7
        if-no-files-found: ignore
